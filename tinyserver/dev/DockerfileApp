ARG DENO_VERSION=1.28.3
ARG NODE_VERSION=18.12.1

ARG DENO_BIN_IMAGE=denoland/deno:bin-${DENO_VERSION}


FROM ${DENO_BIN_IMAGE} AS denobin

FROM node:${NODE_VERSION}-slim AS node

FROM ubuntu:focal-20221130 as base

USER root

RUN apt-get update \
    && apt-get -qq install -y --no-install-recommends \
    tini \
    && rm -rf /var/lib/apt/lists/*

COPY --from=denobin /deno /bin/deno
COPY --from=node /usr/local/include/ /usr/local/include/
COPY --from=node /usr/local/lib/ /usr/local/lib/
COPY --from=node /usr/local/bin/ /usr/local/bin/

RUN corepack disable && corepack enable

COPY db-prisma-proxy-https/ssl-certs/db-prisma-proxy-https/local/signed.crt /usr/local/share/ca-certificates/extra/db-prisma-proxy-https.crt

RUN apt-get update -y && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/* && update-ca-certificates

RUN apt-get update -y \
    && apt-get upgrade -y \
    && apt-get autoremove -y \
    && apt-get install -y software-properties-common \
    && add-apt-repository ppa:git-core/ppa \
    && apt-get update -y

RUN apt-get install -y git

RUN addgroup --gid 1000 vscode \
  && adduser --uid 1000 --disabled-password vscode --ingroup vscode \
  && mkdir /deno-dir/ \
  && chown vscode:vscode /deno-dir/